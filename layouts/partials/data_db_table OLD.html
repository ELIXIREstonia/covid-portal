  {{/*
    Select entries to display. Below is a convoluted way of checking whether the current page is a primary category page which is needed because I am not using the native Hugo way of breaking the information/pages into subcategories using subfolders (but rather have everything in one folder.)
    First, check if the current page is a primary category page by comparing the titles and if it is, then append all entries for this category to an array (slice).
    Then, if there were any entries appended to the array in the previous step, select only unique entries for display. If no entries were appended (i.e., this is not a primary category page), then use Hugo native way of displaying the entries (either all entries or specific subcategory entries.)
  */}}

{{ $all_entries_in_category := slice }}
{{ $current_category := .Title | lower }}
{{ range $taxonomy_term, $taxonomy := .Site.Taxonomies }}
                {{ if eq $taxonomy_term $current_category}}
                      {{ range $key, $value := $taxonomy }}
                            {{ range $value.Pages }}
                                    {{ $all_entries_in_category = $all_entries_in_category | append .Page }}
                            {{ end }}
                      {{ end }}
                {{ end }}
{{ end }}

{{ $sel_entries := slice }}
{{ if gt (len $all_entries_in_category) 0}}
  {{ $sel_entries = $all_entries_in_category | uniq }}
{{ else }}
  {{ $sel_entries = .RegularPages }}
{{ end }}

{{/*
  Divide selected entries into pages.
*/}}

{{ $sel_entries_sorted := ($sel_entries.ByParam "published").Reverse }}
{{ $paginator := .Paginate $sel_entries_sorted 20}}

{{/*
  Compose table title.
*/}}

{{ $composed_title := slice "Page" }}
{{ $composed_title = $composed_title | append ($paginator.PageNumber | string) }}
{{ $composed_title = $composed_title | append "out of" }}
{{ $composed_title = $composed_title | append ($paginator.TotalPages | string) }}
{{ $composed_title = $composed_title | append "in" }}
{{ if gt (len $all_entries_in_category) 0}}
  {{ $composed_title = $composed_title | append ((strings.TrimLeft "Available_data/" .Title) | title | humanize) }}
{{ else }}
  {{ $composed_title = $composed_title | append ((strings.TrimLeft "Available_data/" .Parent.Title) | title | humanize) }}
  {{ $composed_title = $composed_title | append ">" }}
  {{ $composed_title = $composed_title | append (.Title | humanize | title) }}
{{ end }}
{{ $composed_title = delimit $composed_title " "}}

<div class="container">
  <div class="row">
    {{ partial "data_db_nav.html" . }}
    <div class="col-md-10">
    <div class="row"><h5>{{ $composed_title }}</h5></div>
    <div class="row"><div class="table-responsive-md">
<table class="table table-hover table-bordered">
  <thead class="thead-light">
    <tr>
      <th scope="col">Project</th>
      <th scope="col">Last updated</th>
      <th scope="col">Available data</th>
    </tr>
  </thead>
  <tbody>
    {{ range $index, $element := $paginator.Pages }}
    <tr>
      <td><div class="row mx-0"><div class="col">
              <div class="row"><strong><a target="_blank" href="https://doi.org/{{ .Params.doi }}">{{ .Params.title }}</a></strong></div>
              <div class="row mb-1">
                <span class="text-muted">{{ with .Params.authors }}
                  {{ $n := sub (len .) 1}}
                  {{ range first $n . }}
                      {{ $family := (index . "family") }}
                      {{ $initials := (index . "initials") }}
                      {{ $family }} {{ $initials }},
                  {{ end }}
                  {{ range last 1 . }}
                      {{ $family := (index . "family") }}
                      {{ $initials := (index . "initials") }}
                      {{ $family }} {{ $initials }}
                  {{ end }}
                  {{ end }}
                </span>
          </div>
              <div class="row mb-1">{{if ne .Params.type "journal-article" }} [preprint]&nbsp;{{ end}} <i>{{ .Param "journal.title" }}</i>&nbsp;<b>{{ .Param "journal.volume" }}</b>&nbsp;{{$issue_num := .Param "journal.issue"}}{{ if gt $issue_num 0 }}({{ .Param "journal.issue" }})&nbsp;{{ end }}{{ .Params.article_number }} {{ .Param "journal.pages" }}</div>
              <div class="row"><span class="text-muted">{{ .Params.doi }}</span></div>
              {{if isset .Params "abstract" }}<div class="row">
                <a class="btn btn-link text-dark" data-toggle="collapse" href="#abstract{{ $index }}" role="button" aria-expanded="false" aria-controls="abstract{{ $index }}">
                  Abstract <i class="fas fa-caret-down"></i></a>
                <div class="collapse" id="abstract{{ $index }}">
                  <div class="card card-body">{{ .Params.abstract }}</div>
                </div>
              </div>{{ end }}
            </div></div></td>
      <td>{{ .Params.published.Format "02.01.2006" }}</td>
      <td>
        {{ with .Params.data }}
            {{ range . }}
                {{ $data_description := (index . "description") }}
                {{ $data_url := (index . "URL") }}
                <a target="_blank" href="{{ $data_url }}">{{ $data_description }}</a><br>
            {{ end }}
        {{ end }}
      </td>
    </tr>
    {{ end }}
  </tbody>
</table></div>
<div>{{ template "_internal/pagination.html" . }}</div>
</div>

</div>
</div>
</div>
